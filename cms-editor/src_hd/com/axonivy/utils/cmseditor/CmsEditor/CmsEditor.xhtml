<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions">
<h:body>
  <ui:composition template="/layouts/frame-10-full-width.xhtml">
    <ui:define name="title">#{ivy.cms.co('/Labels/CMSEditor/name')}</ui:define>
    <ui:define name="content">
      <h:outputStylesheet name="layouts/styles/translatinglanguages.css" />
      <h:outputScript name="resources/cms-editor.js" target="head" />
      <h:form id="content-form" onkeypress="if (event.keyCode == 13){return false;}">
        <p:remoteCommand id="check-and-show" name="showWarningDailog" global="false" process="@this" update="@this"
          partialSubmit="true" actionListener="#{cmsEditorBean.checkisEditingAndShowMessage()}" />
        <p:remoteCommand id="set-value" name="setRowChange" global="false" process="@this" update="@this"
          partialSubmit="true" actionListener="#{cmsEditorBean.rowSelect}" />
        <h:panelGroup styleClass="flex flex-column">
          <!-- Title -->
          <div class="mb-2">
            <span class="text-xl font-small">#{ivy.cms.co("/Labels/ProjectCmsTitle")}</span>
          </div>
          <div class="grid align-items-center">
            <div class="col-4 project-column">
              <p:selectOneMenu id="app" value="#{cmsEditorBean.selectedProjectName}" class="w-full">
                <f:selectItem itemLabel="#{ivy.cms.co('/Labels/AllProjects')}" itemValue="#{null}" />
                <f:selectItems value="#{cmsEditorBean.projectCms}" />
                <p:ajax process="@this" listener="#{cmsEditorBean.onAppChange}" />
              </p:selectOneMenu>
            </div>

            <div class="col-8 search-column">
              <span class="ui-input-icon-left w-full"> <i class="pi pi-search" /> <p:inputText id="search-input"
                  value="#{cmsEditorBean.searchKey}" placeholder="#{ivy.cms.co('/Labels/Search')}"
                  styleClass="w-full p-inputtext">
                  <p:ajax event="keyup" listener="#{cmsEditorBean.search}"
                    update="table-cms-keys content-form:cms-values content-form:cms-edit-value" delay="500"
                    process="@this" />
                </p:inputText>
              </span>
            </div>
          </div>

          <div class="grid h-full" id="column-container">
            <h:panelGroup layout="block" id="link-column" styleClass="col-4 columns">
              <div class="column-header link-label font-semibold text-lg">#{ivy.cms.co('/Labels/Links')}</div>
              <h:panelGroup styleClass="panel left w-full">
                <p:dataTable id="table-cms-keys" value="#{cmsEditorBean.filteredCMSKeys}" var="entry"
                  selection="#{cmsEditorBean.selectedCms}" selectionMode="single" rowKey="#{entry.uri}"
                  scrollHeight="100%" pageLinks="5" styleClass="cms-link-table"
                  onRowClick="showWarningDailog(); return false;">
                  <p:column>
                    <div class="link-row">
                      <h:outputText id="cms-uri" class="cms-uri" value="#{entry.uri}" />
                      <h:panelGroup rendered="#{entry.differentWithApplication}">
                        <span class="orange-dot"></span>
                      </h:panelGroup>
                    </div>
                    <p:tooltip for="cms-uri" value="#{entry.uri} (#{entry.pmvName})" position="top" />
                  </p:column>
                  <p:ajax event="rowSelect" process="@this" update="@this" partialSubmit="true"
                    oncomplete="setRowChange()" />
                </p:dataTable>
              </h:panelGroup>
            </h:panelGroup>

            <h:panelGroup layout="block" id="current-cms-column" styleClass="col-4 flex flex-column columns">
              <div class="column-header font-semibold text-lg cms-title">
                <span>#{ivy.cms.co('/Labels/CMS')}</span> <i class="pi pi-info-circle cms-info-icon"
                  title="CMS information"></i>
              </div>
              <h:panelGroup styleClass="panel w-full flex flex-column flex-grow-1" layout="block">
                <h:panelGroup styleClass="flex-grow-1 overflow-auto cms-scroll-wrapper" layout="block">
                  <p:accordionPanel id="cms-values" multiple="true" widgetVar="multiple"
                    value="#{cmsEditorBean.selectedCms.contents}" activeIndex="#{cmsEditorBean.activeIndex}"
                    var="language">
                    <p:tab id="cms-values-tab" title="#{language.locale.displayLanguage}">
                      <h:panelGroup styleClass="ui-fluid">
                        <ic:com.axonivy.utils.cmseditor.component.Editor
                          content="#{empty language.originalContent ? language.content : language.originalContent}"
                          languageIndex="#{language.index}" managedBean="#{cmsEditorBean}" isReadOnly="true"
                          isFormatButtonListVisible="#{language.html}" />
                      </h:panelGroup>
                    </p:tab>
                  </p:accordionPanel>
                </h:panelGroup>

                <h:panelGroup layout="block" styleClass="button-group">
                  <h:panelGroup layout="block" styleClass="cms-warning" id="cms-warning-container">
                    <div class="cms-warning-title">
                      <i class="pi pi-exclamation-triangle cms-warning-icon"></i> <span>
                        #{ivy.cms.co('/Labels/Warning')} </span>
                    </div>
                    <div class="cms-warning-content">
                      <span> #{ivy.cms.co('/Labels/CMSWarningTextForDownload')}<h:commandLink
                          value="#{ivy.cms.co('/Labels/UndoChanges')}" styleClass="cms-warning-link" /></span>
                    </div>
                  </h:panelGroup>
                  <p:commandButton id="download-button" value="#{ivy.cms.co('/Labels/Download')}" icon="pi pi-download"
                    ajax="false" actionListener="#{cmsEditorBean.handleBeforeDownloadFile}"
                    styleClass="w-full mt-3 cms-download-btn"
                    onclick="PrimeFaces.monitorDownload(function() {}, showDialog('downloadSuccessDlg'));">
                    <p:fileDownload value="#{cmsEditorBean.fileDownload}" />
                  </p:commandButton>
                </h:panelGroup>

              </h:panelGroup>
            </h:panelGroup>

            <h:panelGroup layout="block" id="editable-column"
              styleClass="col-4 flex flex-column editable-column columns">
              <div class="column-header font-semibold text-lg cms-title">
                <span>#{ivy.cms.co('/Labels/Edit')}</span> <i class="pi pi-info-circle cms-info-icon"
                  title="Edit CMS information"></i>
              </div>
              <h:panelGroup styleClass="panel end w-full flex flex-column flex-grow-1" layout="block">
                <h:panelGroup styleClass="flex-grow-1 overflow-auto cms-scroll-wrapper" layout="block">
                  <p:accordionPanel id="cms-edit-value" multiple="true" widgetVar="multipleEdit"
                    value="#{cmsEditorBean.selectedCms.contents}" activeIndex="#{cmsEditorBean.activeIndex}"
                    var="language">
                    <p:tab id="cms-values-tab" title="#{language.locale.displayLanguage}">
                      <h:panelGroup styleClass="ui-fluid">
                        <ic:com.axonivy.utils.cmseditor.component.Editor content="#{language.content}"
                          languageIndex="#{language.index}" managedBean="#{cmsEditorBean}"
                          isReadOnly="#{!cmsEditorBean.editableCms}" isFormatButtonListVisible="#{language.html}" />
                      </h:panelGroup>
                    </p:tab>
                  </p:accordionPanel>
                </h:panelGroup>

                <h:panelGroup layout="block" styleClass="button-group">
                  <h:panelGroup layout="block" styleClass="cms-warning" id="cms-warning-save-container">
                    <div class="cms-warning-title">
                      <i class="pi pi-exclamation-triangle cms-warning-icon"></i> <span>
                        #{ivy.cms.co('/Labels/Warning')} </span>
                    </div>
                    <div class="cms-warning-content">
                      <span> #{ivy.cms.co('/Labels/CMSWarningTextForSave')}</span>
                    </div>
                  </h:panelGroup>
                  <p:commandButton id="edit-button" value="#{ivy.cms.co('/Labels/Edit')}" icon="pi pi-pencil"
                    process="@this" update="editable-column" oncomplete="initCmsWarnings();"
                    styleClass="w-full mt-3 ui-button-outlined ui-button-secondary cms-edit-button"
                    actionListener="#{cmsEditorBean.onEditableButton()}" rendered="#{!cmsEditorBean.editableCms}"
                    disabled="#{cmsEditorBean.disableEditableButton}" partialSubmit="true" />
                  <h:panelGroup id="edit-cancel-updating-cms-group" styleClass="flex gap-2 mt-3"
                    rendered="#{cmsEditorBean.editableCms}">
                    <p:commandButton id="cancel-edit-button" value="#{ivy.cms.co('/Labels/Cancel')}" icon="pi pi-times"
                      process="@this" rendered="#{cmsEditorBean.editableCms}"
                      styleClass="flex-1 ui-button-outlined ui-button-secondary cms-cancel-button"
                      actionListener="#{cmsEditorBean.onCancelEditableButton()}" />
                    <p:commandButton id="save-button" value="#{ivy.cms.co('/Labels/Save')}" icon="pi pi-save"
                      process="@this table-cms-keys" rendered="#{cmsEditorBean.editableCms}"
                      actionListener="#{cmsEditorBean.writeCmsToApplication()}"
                      update="table-cms-keys cms-values cms-edit-value editable-column"
                      styleClass="flex-1 ui-button-raised ui-button-primary cms-save-button" onclick="saveAllEditors()"
                      oncomplete="initCmsWarnings();" partialSubmit="true" onstart="destroyEditors()" />
                  </h:panelGroup>
                </h:panelGroup>

              </h:panelGroup>
            </h:panelGroup>
          </div>
        </h:panelGroup>
        <div class="command-btns pt-2">
          <p:remoteCommand name="stop" global="false" partialSubmit="true" process="@this" update="content-form"
            actionListener="#{cmsEditorBean.downloadFinished}" />
          <p:remoteCommand name="saveAllValue" global="false" partialSubmit="true" process="@this"
            actionListener="#{cmsEditorBean.saveAll}" />
        </div>
      </h:form>

      <p:dialog id="downloadSuccessDlg" widgetVar="downloadSuccessDlg" modal="true" closable="false" draggable="false"
        resizable="false" showEffect="fade" hideEffect="fade" showHeader="false" styleClass="success-dialog">
        <div class="text-center p-4">
          <i class="pi pi-check icon-checked"></i>
          <div class="text-lg font-semibold">
            <h:outputText value="#{ivy.cms.co('/Labels/CmsDownloaded')}" escape="false" />
          </div>
        </div>
      </p:dialog>

      <p:dialog id="SaveSuccessDlg" widgetVar="SaveSuccessDlg" modal="true" closable="false" draggable="false"
        resizable="false" showEffect="fade" hideEffect="fade" showHeader="false" styleClass="save-dialog">
        <div class="text-center p-4">
          <i class="pi pi-check icon-checked"></i>
          <div class="text-lg font-semibold">
            <h:outputText value="#{ivy.cms.co('/Labels/CMSSaved')}" escape="false" />
          </div>
        </div>
      </p:dialog>

      <script type="text/javascript">
        window.isHideTaskName = false;
        window.isHideTaskAction = true;
        window.isHideCaseInfo = true;
        window.isWorkingOnATask = false;
      </script>

    </ui:define>
  </ui:composition>
</h:body>

</html>