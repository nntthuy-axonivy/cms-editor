<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component" xmlns:p="http://primefaces.org/ui">
<h:body>
  <ui:composition template="/layouts/frame-10-full-width.xhtml">
    <ui:define name="title">#{ivy.cms.co('/Labels/CMSEditor/name')}</ui:define>
    <ui:define name="content">
      <h:outputStylesheet name="layouts/styles/translatinglanguages.css" />
      <h:outputScript name="resources/cms-editor.js" target="head" />

      <h:form id="content-form" onkeypress="if (event.keyCode === 13){return false;}">
        <p:remoteCommand id="check-and-show" name="showWarningDailog" global="false" process="@this" update="@this"
          partialSubmit="true" actionListener="#{cmsEditorBean.checkIsEditingAndShowMessage()}" />
        <p:remoteCommand id="set-value" name="setRowChange" global="false" process="@this" update="@this"
          partialSubmit="true" actionListener="#{cmsEditorBean.rowSelect}" />
        <h:panelGroup styleClass="flex flex-column">
          <!-- Title -->
          <div class="grid mb-2">
            <span class="text-xl font-small">#{ivy.cms.co("/Labels/ProjectCmsTitle")}</span>
          </div>

          <div class="grid flex flex-column gap-3">
            <div class="project-column w-full">
              <p:selectOneMenu id="app" value="#{cmsEditorBean.selectedProjectName}" class="w-full">
                <f:selectItem itemLabel="All" itemValue="#{null}" />
                <f:selectItems value="#{cmsEditorBean.projectCms}" />
                <p:ajax process="@this" listener="#{cmsEditorBean.onAppChange}" />
              </p:selectOneMenu>
            </div>
            <div class="search-column w-full">
              <span class="ui-input-icon-left w-full"> <i class="pi pi-search" /> <p:inputText id="search-input"
                  value="#{cmsEditorBean.searchKey}" placeholder="#{ivy.cms.co('/Labels/Search')}"
                  styleClass="w-full p-inputtext">
                  <p:ajax event="keyup" listener="#{cmsEditorBean.search}"
                    update="table-cms-keys content-form:cms-values content-form:cms-edit-value" delay="500"
                    process="@this" />
                </p:inputText>
              </span>
            </div>
          </div>

          <h:panelGroup layout="block" class="grid h-full" id="column-container">
            <h:panelGroup layout="block" id="link-column"
              styleClass="#{cmsEditorBean.editableCms ? 'col-4' : 'col-6'} columns">
              <div class="column-header flex align-items-center justify-content-between">
                <span class="link-label font-semibold text-lg"> #{ivy.cms.co('/Labels/Links')} </span>

                <h:panelGroup layout="block" rendered="#{cmsEditorBean.isRenderResetAllChange()}"
                  class="flex align-items-center gap-2 cursor-pointer">
                  <f:passThroughAttribute name="onclick" value="PF('resetConfirmDlg').show();" />
                  <i class="pi pi-refresh text-red-500" />
                  <span class="text-red-500 font-medium"> Reset all changes </span>
                </h:panelGroup>
              </div>

              <h:panelGroup styleClass="panel left w-full">
                <p:dataTable id="table-cms-keys" value="#{cmsEditorBean.filteredCMSKeys}" var="entry"
                  selection="#{cmsEditorBean.selectedCms}" selectionMode="single" rowKey="#{entry.uri}"
                  scrollHeight="100%" pageLinks="5" styleClass="cms-link-table"
                  onRowClick="showWarningDailog(); return false;">
                  <p:column>
                    <div class="link-row">
                      <h:outputText id="cms-uri" class="cms-uri" value="#{entry.uri}" />
                      <h:panelGroup rendered="#{entry.differentWithApplication}">
                        <span class="orange-dot" />
                      </h:panelGroup>
                    </div>
                    <p:tooltip for="cms-uri" value="#{entry.uri} (#{entry.pmvName})" position="top" />
                  </p:column>
                  <p:ajax event="rowSelect" process="@this" update="@this" partialSubmit="true"
                    oncomplete="setRowChange()" />
                </p:dataTable>
              </h:panelGroup>
            </h:panelGroup>

            <h:panelGroup layout="block" id="current-cms-column"
              styleClass="#{cmsEditorBean.editableCms ? 'col-4' : 'col-6'} flex flex-column columns">
              <div class="column-header flex align-items-center justify-content-between">
                <div class="flex align-items-center gap-2">
                  <span class="font-semibold text-lg cms-title"> #{ivy.cms.co('/Labels/CMS')} </span> <i
                    class="pi pi-info-circle cms-info-icon" title="CMS information" />
                </div>

                <p:commandLink rendered="#{cmsEditorBean.isRenderUndoChange()}"
                  actionListener="#{cmsEditorBean.undoChange}"
                  update="column-container table-cms-keys cms-values cms-edit-value"
                  styleClass="flex align-items-center gap-2 cursor-pointer undo-action">
                  <i class="pi pi-undo text-blue-500"></i>
                  <span class="text-blue-500 font-medium"> #{ivy.cms.co('/Labels/UndoChanges')} </span>
                </p:commandLink>

              </div>
              <h:panelGroup styleClass="panel w-full flex flex-column flex-grow-1" layout="block">
                <h:panelGroup styleClass="flex-grow-1 overflow-auto cms-scroll-wrapper" layout="block">
                  <p:accordionPanel id="cms-values" multiple="true" widgetVar="multiple"
                    value="#{cmsEditorBean.selectedCms.contents}" activeIndex="#{cmsEditorBean.activeIndex}"
                    var="language">
                    <p:tab id="cms-values-tab" title="#{language.locale.displayLanguage}">
                      <h:panelGroup styleClass="ui-fluid">
                        <ic:com.axonivy.utils.cmseditor.component.Editor originalContent="#{language.originalContent}"
                          content="#{language.content}" languageIndex="#{language.index}" managedBean="#{cmsEditorBean}"
                          isReadOnly="true" isFormatButtonListVisible="#{language.html}" />
                      </h:panelGroup>
                    </p:tab>
                  </p:accordionPanel>
                </h:panelGroup>

                <h:panelGroup layout="block" styleClass="button-group">

                  <h:panelGroup id="save-success-bar" layout="block"
                    styleClass="save-success-bar flex align-items-center gap-2 p-3 border-round font-medium shadow-2">
                    <i class="pi pi-check"></i>
                    <span>Changes saved</span>
                  </h:panelGroup>

                  <h:panelGroup layout="block" styleClass="cms-warning mt-2" id="cms-warning-container">
                    <div class="cms-warning-title">
                      <i class="pi pi-exclamation-triangle cms-warning-icon" /> <span>
                        #{ivy.cms.co('/Labels/Warning')} </span>
                    </div>
                    <div class="cms-warning-content">
                      <span> #{ivy.cms.co('/Labels/CMSWarningTextForDownload')}<h:commandLink
                          value="#{ivy.cms.co('/Labels/UndoChanges')}" styleClass="cms-warning-link" /></span>
                    </div>
                  </h:panelGroup>

                  <h:panelGroup layout="block" id="download-edit-button-container" styleClass="flex">
                    <p:commandButton id="download-button" value="#{ivy.cms.co('/Labels/Download')}"
                      icon="pi pi-download" ajax="false" actionListener="#{cmsEditorBean.handleBeforeDownloadFile}"
                      styleClass="w-full mt-3 cms-download-btn"
                      onclick="PrimeFaces.monitorDownload(function() {}, showDialog('downloadSuccessDlg'));">
                      <p:fileDownload value="#{cmsEditorBean.fileDownload}" />
                    </p:commandButton>
                    <p:commandButton id="edit-button" value="#{ivy.cms.co('/Labels/Edit')}" icon="pi pi-pencil"
                      process="@this" update="column-container" oncomplete="initCmsWarnings();"
                      styleClass="w-full mt-3 ui-button-outlined ui-button-secondary cms-edit-button"
                      actionListener="#{cmsEditorBean.onEditableButton()}" rendered="#{!cmsEditorBean.editableCms}"
                      disabled="#{cmsEditorBean.disableEditableButton}" partialSubmit="true" />
                  </h:panelGroup>
                </h:panelGroup>

              </h:panelGroup>
            </h:panelGroup>

            <h:panelGroup layout="block" id="editable-column" rendered="#{cmsEditorBean.editableCms}"
              styleClass="col-4 flex flex-column editable-column columns">
              <div class="column-header font-semibold text-lg cms-title">
                <span>#{ivy.cms.co('/Labels/Edit')}</span> <i class="pi pi-info-circle cms-info-icon"
                  title="Edit CMS information" />
              </div>
              <h:panelGroup styleClass="panel end w-full flex flex-column flex-grow-1" layout="block">
                <h:panelGroup styleClass="flex-grow-1 overflow-auto cms-scroll-wrapper" layout="block">
                  <p:accordionPanel id="cms-edit-value" multiple="true" widgetVar="multipleEdit"
                    value="#{cmsEditorBean.selectedCms.contents}" activeIndex="#{cmsEditorBean.activeIndex}"
                    var="language">
                    <p:tab id="cms-values-tab" title="#{language.locale.displayLanguage}">
                      <h:panelGroup styleClass="ui-fluid">
                        <ic:com.axonivy.utils.cmseditor.component.Editor content="#{language.content}"
                          languageIndex="#{language.index}" managedBean="#{cmsEditorBean}"
                          isReadOnly="#{!cmsEditorBean.editableCms}" isFormatButtonListVisible="#{language.html}" />
                      </h:panelGroup>
                    </p:tab>
                  </p:accordionPanel>
                </h:panelGroup>

                <h:panelGroup layout="block" styleClass="button-group">
                  <h:panelGroup layout="block" styleClass="cms-warning" id="cms-warning-save-container">
                    <div class="cms-warning-title">
                      <i class="pi pi-exclamation-triangle cms-warning-icon" /> <span>
                        #{ivy.cms.co('/Labels/Warning')} </span>
                    </div>
                    <div class="cms-warning-content">
                      <span> #{ivy.cms.co('/Labels/CMSWarningTextForSave')}</span>
                    </div>
                  </h:panelGroup>

                  <h:panelGroup layout="block" id="cancel-save-button-container" styleClass="flex">
                    <p:commandButton id="cancel-edit-button" value="#{ivy.cms.co('/Labels/Cancel')}" icon="pi pi-times"
                      process="@this" styleClass="flex-1  mt-3 ui-button-outlined ui-button-secondary cms-cancel-button"
                      update="column-container" actionListener="#{cmsEditorBean.onCancelEditableButton()}" />
                    <p:commandButton id="save-button" value="#{ivy.cms.co('/Labels/Save')}" icon="pi pi-save"
                      process="@this table-cms-keys" actionListener="#{cmsEditorBean.writeCmsToApplication()}"
                      update="table-cms-keys cms-values cms-edit-value editable-column"
                      styleClass="flex-1  mt-3 ui-button-raised ui-button-primary cms-save-button"
                      onclick="saveAllEditors()" oncomplete="initCmsWarnings(); showSaveSuccess();" partialSubmit="true"
                      onstart="destroyEditors()" />
                  </h:panelGroup>

                </h:panelGroup>
              </h:panelGroup>
            </h:panelGroup>
          </h:panelGroup>
        </h:panelGroup>
        <div class="command-btns pt-2">
          <p:remoteCommand name="stop" global="false" partialSubmit="true" process="@this" update="content-form"
            actionListener="#{cmsEditorBean.downloadFinished}" />
          <p:remoteCommand name="saveAllValue" global="false" partialSubmit="true" process="@this"
            actionListener="#{cmsEditorBean.saveAll}" />
        </div>

        <p:dialog id="resetConfirmDlg" widgetVar="resetConfirmDlg" modal="true" closable="true" draggable="false"
          resizable="false" showHeader="false" styleClass="reset-confirm-dialog" width="420">
          <div class="p-4">
            <div class="text-lg font-semibold mb-2">Are you sure you want to reset all changes?</div>
            <div class="mb-3">
              <span class="text-sm text-color-secondary"> Enter <b>reset</b> to confirm
              </span>
              <p:inputText id="resetConfirmInput" value="#{cmsEditorBean.resetConfirmText}" styleClass="w-full mt-2">
                <p:ajax event="keyup" update="resetBtn" />
              </p:inputText>
            </div>
            <div class="flex justify-content-end gap-2">
              <p:commandButton value="Cancel" styleClass="ui-button-secondary ui-button-outlined"
                onclick="PF('resetConfirmDlg').hide(); return false;" />
              <p:commandButton id="resetBtn" value="Reset" icon="pi pi-refresh" styleClass="ui-button-danger"
                actionListener="#{cmsEditorBean.resetAllChanges}"
                update="column-container table-cms-keys cms-values cms-edit-value"
                disabled="#{cmsEditorBean.resetConfirmText ne 'reset'}" oncomplete="PF('resetConfirmDlg').hide();" />
            </div>
          </div>
        </p:dialog>
      </h:form>

      <p:dialog id="downloadSuccessDlg" widgetVar="downloadSuccessDlg" modal="true" closable="false" draggable="false"
        resizable="false" showEffect="fade" hideEffect="fade" showHeader="false" styleClass="success-dialog">
        <div class="text-center p-4">
          <i class="pi pi-check icon-checked" />
          <div class="text-lg font-semibold">
            <h:outputText value="#{ivy.cms.co('/Labels/CmsDownloaded')}" escape="false" />
          </div>
        </div>
      </p:dialog>

      <script type="text/javascript">
        window.isHideTaskName = false;
        window.isHideTaskAction = true;
        window.isHideCaseInfo = true;
        window.isWorkingOnATask = false;
      </script>

    </ui:define>
  </ui:composition>
</h:body>

</html>
